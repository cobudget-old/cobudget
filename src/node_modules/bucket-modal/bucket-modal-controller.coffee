_ = require('lodash')

### @ngInject ###
module.exports = ($scope, $modalInstance, BucketsStore, BucketModel, AuthService, UserModel, group, round, bucket) ->

  currentUser = new UserModel(AuthService.getCurrentUser())

  if group.isAdmin(currentUser)
    $scope.sponsors = group.members
  else
    $scope.sponsors = [currentUser]

  $scope.data = {}

  if bucket
    _.extend(
      $scope.data,
      {
        id: bucket.id
        name: bucket.name
        description: bucket.description
        user: _.find $scope.sponsors, (u) ->
          u.id == bucket.user.id
        target: Number(bucket.target.toFixed(2))
      }
    )

    $scope.title = "Edit Bucket!"
  else
    $scope.title = "New Bucket!"

  $scope.data.roundId = round.id

  $scope.submit = (bucketForm) ->
    $scope.submitted = true

    if bucketForm.$invalid
      return

    data = $scope.data
    data.user = data.user.toJSON()

    unsavedBucket = new BucketModel(data)

    BucketsStore.save(unsavedBucket)
    .then (savedBucket) ->
      $modalInstance.close(savedBucket)
    , (err) ->
      # pass error back up
      $modalInstance.dismiss(err)

  $scope.cancel = ->
    $modalInstance.dismiss(null)
