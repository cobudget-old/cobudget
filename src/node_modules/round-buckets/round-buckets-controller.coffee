_ = require('lodash')

errorModal = require('error-modal')

### @ngInject ###
module.exports = ($scope, $rootScope, $q, $modal, RoundsStore, ContributionsStore, AuthService, BucketsStore, group, round) ->

  $scope.round = round

  currentUser = AuthService.getCurrentUser()
  $scope.canProposeBuckets = group.isAdmin(currentUser) or (
    round.status.name == "pending" and
    round.membersCanProposeBuckets
  )

  handleError = (err) ->
    if (err and err != "backdrop click")
      # handle error
      $modal.open(errorModal({ error: err }))

  delete $rootScope.selectedBucketId
  $scope.isSelected = (bucket) ->
    bucket.id == $rootScope.selectedBucketId

  $scope.saveContribution = (contribution) ->
    # if we're gonna have a bad time
    if round.balanceStatus == 'danger'
      # gtfo
      return $q.reject(new Error("balance status is dangerous"))
    # if no longer contributing a positive amount
    if not contribution.amount.gt(0)
      if contribution.id
        # remove from contributions store
        return ContributionsStore.remove(contribution)
        .then null, handleError
      return $q.reject(new Error("empty contribution"))
    ContributionsStore.save(contribution)
    .then null, handleError

  $scope.openNewBucketModal = ->
    $modal.open(
      require('bucket-modal')(
        round: round
        group: group
      )
    ).result.then (bucket) ->
      # TODO add new bucket in proper sort order
      round.buckets.models.splice(0, 0, bucket)
    , handleError
